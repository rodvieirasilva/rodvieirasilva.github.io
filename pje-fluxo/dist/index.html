<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<!-- <link href="~/css/admin.css" media="screen" rel="stylesheet" /> -->
	<link href="../node_modules/monaco-editor/min/vs/editor/editor.main.css" rel="stylesheet" />
	<link href="https://visjs.github.io/vis-network/standalone/umd/vis-network.min.css" rel="stylesheet" />
	<script type="text/javascript" src="https://visjs.github.io/vis-network/standalone/umd/vis-network.min.js"></script>


	<script>var require = { paths: { 'vs': '../node_modules/monaco-editor/min/vs' } };</script>
	<script type="text/javascript" src="../node_modules/monaco-editor/min/vs/loader.js"></script>
	<script type="text/javascript" src="../node_modules/monaco-editor/min/vs/editor/editor.main.nls.js"></script>
	<script type="text/javascript" src="../node_modules/monaco-editor/min/vs/editor/editor.main.js"></script>
	<script type="text/javascript" src="ANPREV.fluxo.js"></script>

	<style>
		.row {
			display: flex;
		}

		.col {
			flex: 1;
			padding: 1em;
			border: solid;
		}
	</style>
</head>

<body class="row" style="height: 100vh;">
	<div class="col">
		<div id="editor">

		</div>
	</div>
	<div id="graph" class="col">
	</div>

	<script type="text/javascript">
		var starts = Array.from(xmlDoc.getElementsByTagName('start-state'));
		var decision = Array.from(xmlDoc.getElementsByTagName('decision'));
		var nodes = Array.from(xmlDoc.getElementsByTagName('node'));
		var states = Array.from(xmlDoc.getElementsByTagName('process-state'));
		var tasks = Array.from(xmlDoc.getElementsByTagName('task-node'));
		var ends = Array.from(xmlDoc.getElementsByTagName('end-state'));



		graph_nodes = starts.concat(decision, nodes, states, tasks, ends);

		var id = 1;
		var dict = {};
		// create an array with nodes
		var nodes = new vis.DataSet(
			graph_nodes.map(function (node) {
				var result = {};
				result.id = id++;
				result.label = node.getAttribute('name');
				node.id = result.id;
				dict[result.label] = node;
				return result;
			})
		);
		var transitions = [];
		graph_nodes.forEach(function (node) {

			Array.from(node.getElementsByTagName('transition')).forEach(function (transition) {
				var result = {};
				result.from = node.id;
				var toName = transition.getAttribute('to');
				if (toName in dict) {
					result.to = dict[transition.getAttribute('to')].id;
				} else {
					console.log('Not found:' + toName);
				}
				var edgeName = transition.getAttribute('name');
				if (edgeName != toName) {
					result.label = transition.getAttribute('name')
				}
				result.arrows = {
					to: {
						enabled: true,
						type: 'arrow'
					}
				};
				transitions.push(result);
			})
		});

		// create an array with edges
		var edges = new vis.DataSet(transitions);

		// create a network
		var container = document.getElementById('graph');
		var data = {
			nodes: nodes,
			edges: edges
		};
		// var options = {
		// 	enabled: true,
		// 	filter: 'physics, layout',
		// 	showButton: true,
		// 	barnesHut: {
		// 		avoidOverlap: 1
		// 	},
		// 	hierarchical: {
		// 		enabled: true,
		// 		nodeSpacing: 425,
		// 		blockShifting: false,
		// 		edgeMinimization: false,
		// 		sortMethod: "directed"
		// 	},
		// 	interaction: {
		// 		dragNodes: true
		// 	},
		// 	hierarchicalRepulsion: {
		// 		avoidOverlap: 1
		// 	}
		// 	// manipulation: false,
		// 	// layout: {
		// 	// 	// hierarchical: {
		// 	// 	// 	enabled: true,
		// 	// 	// 	levelSeparation: 100
		// 	// 	// }
		// 	// },
		// 	// physics: {
		// 	// 	enabled: true,
		// 	// 	hierarchicalRepulsion: {
		// 	// 		centralGravity: 0.0,
		// 	// 		springLength: 700,
		// 	// 		springConstant: 0.01,
		// 	// 		nodeDistance: 700,
		// 	// 		damping: 0.09
		// 	// 	}
		// 	// }
		// };
		var options = {
			physics: {
				hierarchicalRepulsion: {
					avoidOverlap: 1
				}
			}
		};
		var network = new vis.Network(container, data, options);
		network.on("stabilizationIterationsDone", function () {
			network.setOptions({
				nodes: { physics: false },
				edges: { physics: false },
			});
		});

	</script>

	<script>
		"use strict";
		var el = document.getElementById('editor');
		el.style.width = "100%";
		el.style.height = "100%";
		// window.editor is accessible. 
		var editor = null;
		var init = function () {

			require(['vs/editor/editor.main'], function () {

				editor = monaco.editor.create(el, {
					theme: 'vs-dark',
					model: monaco.editor.createModel(ANPREV_fluxo, "xml")
				});

				editor.layout();
			});

			window.removeEventListener("load", init);
		};
		//init();
		window.addEventListener("load", init);
	</script>

</body>


</html>